<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<div class="card mb-4" th:fragment="vacationRequest">
    <div class="card-header">
        <i class="fas fa-table me-1"></i>
        휴가 신청 내역
    </div>

    <div class="card-body">
        <table id="vacationMyHistory" class="table table-hover" style="width:100%">
            <thead>
            <tr>
                <th>이름</th>
                <th>사용 기간</th>
                <th>종류</th>
                <th>증명자료</th>
                <th>승인</th>
                <th></th>
            </tr>
            </thead>

            <tbody>
            <th:block th:if="${#lists.isEmpty(vacationRequestList)}">
                <tr>
                    <td style="text-align: center">신청 내역 없음</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
            </th:block>

            <th:block th:if="${!#lists.isEmpty(vacationRequestList)}">
                <tr onclick="openModal(this)" data-bs-toggle="modal" data-bs-target="#vacationRequestModify"
                    th:each="dto : ${vacationRequestList}"
                    th:data-employee-name="${session.employee.employeeName}"
                    th:data-period="|${dto.startDate} ~ ${dto.endDate}|"
                    th:data-type-name="${dto.vacationType.description}"
                    th:data-type="${dto.vacationType}"
                    th:data-attachment-file="${#strings.escapeJavaScript(dto.fileList)}"
                    th:data-status-name="${dto.status.description}"
                    th:data-status="${dto.status}"
                    th:data-contents="${dto.contents}">

                    <td th:text="${session.employee.employeeName}">사원 이름</td>
                    <td th:text="|${dto.startDate} ~ ${dto.endDate}|">사용 기간</td>
                    <td th:text="${dto.vacationType.description}">종류</td>
                    <td th:text="${dto.fileList.size() > 0 ? '첨부 파일 있음' : '첨부 파일 없음'}">증명자료</td>
                    <td th:text="${dto.status.description}">승인</td>
                    <td onclick="">삭제버튼</td>
                </tr>
            </th:block>
            </tbody>
        </table>
    </div>

    <!-- Modal -->
    <div class="container modal fade" id="vacationRequestModify" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="staticBackdropLabel"
                        th:text="|${session.employee.employeeName} 님의 병가 요청|">@@@님의 휴가 요청</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h5>요청내역 인증완료(표시)</h5>
                    <div class="container border">
                        <table style="margin: 10px">
                            <tr>
                                <th>휴가 종류 : </th>
                                <td><div id="modalType"></div></td>
                            </tr>
                            <tr>
                                <th>휴가 기간 : </th>
                                <td><input type="text" name=""
                                           placeholder="Select Date.." class="form-control vacationDate" id="modalPeriod">
                                    <input type="hidden" value="">
                                    <input type="hidden" value="">
                                </td>
                            </tr>
                            <tr>
                                <th>승인 상태 : </th>
                                <td><div id="modalStatus"></div></td>
                            </tr>
                            <tr>
                                <th>휴가 내용 : </th>
                                <td><textarea id="modalContents"></textarea></td>
                            </tr>
                            <tr id="modalAttachment">
                                <th>첨부 파일 : </th>
                                <!-- 첨부파일이 있으면 첨부파일 링크를 출력 -->
                            </tr>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" id="annualModifyBtn">수정</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        function openModal(element) {
            // 데이터 속성 가져오기
            const employeeName = element.getAttribute('data-employee-name');
            const period = element.getAttribute('data-period');
            const type = element.getAttribute('data-type');
            const typeName = element.getAttribute('data-type-name');
            const attachmentFileList = element.getAttribute('data-attachment-file');
            const statusName = element.getAttribute('data-status-name');
            const status = element.getAttribute('data-status');
            const contents = element.getAttribute('data-contents');

            // 모달에 데이터 설정하기
            document.getElementById('staticBackdropLabel').innerText = employeeName + "님의 휴가 요청";
            document.getElementById('modalPeriod').value = period;
            document.getElementById('modalType').innerText = typeName;
            document.getElementById('modalStatus').innerText = statusName;
            document.getElementById('modalContents').value = contents;

            // 첨부파일 목록 설정하기
            let modalAttachment = document.getElementById('modalAttachment');
            modalAttachment.innerHTML = ''; // 기존 내용을 초기화
            if (attachmentFileList && attachmentFileList !== '[]') {
                try {
                    const attachmentFiles = parseAttachmentFileList(attachmentFileList);
                    attachmentFiles.forEach(file => {
                        const link = document.createElement('a');
                        link.href = `/board/detail/download/${file.filePath}`; // 실제 파일 URL로 교체
                        link.textContent = file.fileName; // 파일 이름으로 교체
                        modalAttachment.appendChild(link);
                        modalAttachment.appendChild(document.createElement('br'));
                    });
                } catch (e) {
                    modalAttachment.textContent = '첨부 파일을 불러오는 중 오류가 발생했습니다.';
                    console.error("첨부 파일 파싱 오류:", e);
                }
            } else {
                modalAttachment.textContent = '첨부 파일 없음';
            }



            $("#annualModifyBtn").on("click", function (e) {
                e.preventDefault(); // 기본 submit 동작을 막음

                // 데이터 속성 가져오기
                const attachment = $('#modalAttachment').val();
                const contents = $('#modalContents').val();
                let startDate;
                let endDate;

                // 날짜 값을 분리
                let split = $('#modalPeriod').val().split('~');
                console.log(split);

                if (split.length === 2) {
                    startDate = split[0].trim();
                    endDate = split[1].trim();
                } else {
                    startDate = split[0].trim();
                    endDate = split[0].trim();
                }
                // 분리된 값을 폼에 추가
                $("#startDate").val(startDate);
                $("#endDate").val(endDate);

                // 결과 출력 (디버깅용)
                console.log("startDate: ", startDate);
                console.log("endDate: ", endDate);
                console.log("contents: ", contents);
                $.ajax({
                    url: '/vacation/annual',
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        startDate: startDate,
                        endDate: endDate,
                        vacationType: type,
                        file: attachment,
                        status: status,
                        contents: contents
                    }),
                    success: function(response) {
                        console.log("Success:", response);
                        $('#annual').modal('hide');
                        location.reload();
                    },
                    error: function(xhr) {
                        if (xhr.status === 400) {
                            let errorResult = xhr.responseJSON;
                            let errorMessage = errorResult.message + '\n';
                            if (errorResult.fieldErrors) {
                                errorMessage += "\n";
                                for (let field in errorResult.fieldErrors) {
                                    errorMessage += field + ': ' + errorResult.fieldErrors[field] + '\n';
                                }
                            }
                            alert("Errors:\n" + errorMessage);
                        } else {
                            alert("다시 시도해주세요");
                        }
                    }
                });
            });
        }

        function parseAttachmentFileList(attachmentFileList) {
            const fileList = [];
            const regex = /VacationFileDTO\(fileName=([^,]+), filePath=([^\)]+)\)/g;
            let match;
            while ((match = regex.exec(attachmentFileList)) !== null) {
                fileList.push({
                    fileName: decodeUnicodeEscapeSequence(match[1].trim()), // 파일 이름을 디코딩하여 한글로 표시
                    filePath: decodeUnicodeEscapeSequence(match[2].trim())
                });
            }
            return fileList;
        }

        function decodeUnicodeEscapeSequence(str) {
            return str.replace(/\\u[\dA-F]{4}/gi,
                function (match) {
                    return String.fromCharCode(parseInt(match.replace(/\\u/g, ''), 16));
                });
        }
    </script>
</div>
</html>
